```{r}
# tinytex::lualatex(
#   file = "test.tex",
#   pdf_file = "test.pdf"
# )

# set "report" as wd
# Note: RUN THIS IN THE CONSOLE, not in the chunk itself. Otherwise it won't run...
tinytex::lualatex(
  file = "SAR_species_skeleton.tex",
  pdf_file = "test.pdf"
)
```

This compiles! An easy MRE
```{latex}
\DocumentMetadata{
  lang        = en,
  pdfstandard = ua-2,
  pdfstandard = a-4f, %or a-4
  tagging=on,
  tagging-setup={math/setup=mathml-SE} 
}
\documentclass{article}
\begin{document}
\section{Start}
\tagpdfsetup{table/header-rows={1,2}}
\begin{tabular}{lr}
\multicolumn{2}{c}{Example}\\
Name&Value\\
This& 11 \\
That & 2
\end{tabular}
\end{document}
```


All I had to do was paste this text into the SAR_species_skeleton.tex file (the Tables section), then compile it!
```{latex}
\tagpdfsetup{table/header-rows={1,2}}
\begin{tabular}{lr}
\multicolumn{2}{c}{Example}\\
Name&Value\\
This& 11 \\
That & 2
\end{tabular}
```


# Diving deeper:
```{latex}
% all I did was take kable's output and add the tagpdfsetup line first
% and now I'm commenting out some other lines

% -this does tag it as a table! I had to change header=rows to 1, not 1&2
\tagpdfsetup{table/header-rows={1}}

% the {table} lines also prevent the table from being tagged
% \begin{table}[!h]
\centering

% CAPTION DOESN'T WORK- makes compiling fail
% ! Undefined control sequence.
% <argument> g__tocbasic_\@captype 
%                       _caption_above_bool
% \caption{Summary statistics of air pollution data}

\centering
\begin{tabular}[t]{rr}
\toprule
x & y\\
\midrule
1 & 2\\
\bottomrule
\end{tabular}

% the {table} lines also prevent the table from being tagged
% \end{table}
```

# Try using xtable
Make R table into latex code
This doesn't produce a tagged table when inserted into a tex doc
```{r}
sample_table <- data.frame(x = 1, y = 2)
tex_table <- xtable::xtable(sample_table)

print(tex_table)
```

```{latex}
% latex table generated in R 4.5.1 by xtable 1.8-4 package
% Thu Sep 18 17:15:02 2025
\begin{table}[ht]
\centering
\begin{tabular}{rrr}
  \hline
 & x & y \\ 
  \hline
1 & 1.00 & 2.00 \\ 
   \hline
\end{tabular}
\end{table}
```

When this line is added to the start of the tex_table, it still doesn't work
```{latex}
\tagpdfsetup{table/header-rows={1}}
```

# Let's try kable
```{r}
knitr::kable(sample_table, format = "latex")
```

Produces:
```{latex}
\begin{tabular}{r|r}
\hline
x & y\\
\hline
1 & 2\\
\hline
\end{tabular}
```

Does it tag as a table when compiled?
YES!!
But it's tagging the header cells as data cells
```{r}
knitr::kable(sample_table, format = "latex", booktabs = TRUE)
```

Produces:
```{latex}
\begin{tabular}{rr}
\toprule
x & y\\
\midrule
1 & 2\\
\bottomrule
\end{tabular}
```

The only way I can find that tags the header cells as such is to add this line before the other kable text:
```{latex}
\tagpdfsetup{table/header-rows={1}}
% where the number of header rows is given
```



# Attempt to make a workflow that:
1. in stockplotr: takes a df (just before flextable() is applied to it)
2. in asar: Applies kable() to it
3. Calcs number of header rows, then adds it to the tagpdfsetup line
4. Makes latex code from it
5. Inserts it into Tables doc

```{r}
# First, I had to export the raw data used to create a landings table into a csv in the tagged-tbls branch of stockplotr

raw_tbl <- read.csv(
  fs::path(
    getwd(),
    "tables",
    "table_landings_raw.csv"
  )
) |>
  # make the table smaller for testing purposes
  dplyr::select(c(1:3)) |>
  dplyr::filter(Year > 2000)

latex_tbl <- knitr::kable(raw_tbl, format = "latex", booktabs = TRUE)

# add number of header rows
nheaders <- 1
  
init_line <- paste0("\\tagpdfsetup{table/header-rows={", nheaders, "}}")
test_chunk <- paste0(init_line, latex_tbl)
cat(test_chunk)
# then added it to SAR_species_skeleton.tex

# this worked!!!!!!
# BUT:
# - the table was too long and it went off the page (maybe this is addressed with previously-created table splitting fxns?)
# - no caption or label


# Now I'll add the text to the Tables child qmd, with a label, and see if it's labelled
# can't get it to work there. I think maybe I have to add it to the .tex file- not the Quarto doc?


# also, in order to add captions and labels, I believe you have to encase the tabular{} commands in a "table environment" by wrapping the tabular{} commands in begin{table} and end{table} commands (see here:
# https://www.overleaf.com/learn/latex/Questions/How_do_I_add_a_caption_to_a_table%3F
# )
# 
# But compiling fails if I do that.
# 
# I figured out a solution!!
# Gemini says that the table, caption, and label aren't tagged in the table environment because the table environment creates a "float," and this floating mechanism can interfere with how the tagpdf package builds the accessibility structure.
# So an alternative solution is to create a non-floating table with the {caption} package.
# The Steps:
# 1. Add \usepackage{caption} to your document's preamble (was already in there)
# 2. Use \captionof{table}{Your caption...} to add a correctly numbered table caption. Add \label{tab:example} to add a label.
# 3. Can wrap everything in a center environment to center it on the page.

# have to increase the \s to two so that it runs properly
caption <- paste0("\\captionof{table}{",
                  "My table caption",
                  "}")

label <- paste0("\\label{",
                "example-label",
                "}")

test_chunk <- paste0(init_line,
                     "\n",
                     "\\begin{center}",
                     "\n",
                     caption,
                     "\n",
                     label,
                     "\n",
                     latex_tbl,
                     "\n",
                     "\\end{center}")
cat(test_chunk)
# then added it to SAR_species_skeleton.tex and run

tinytex::lualatex(
  file = "SAR_species_skeleton.tex",
  pdf_file = "test.pdf"
)
```

